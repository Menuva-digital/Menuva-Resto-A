<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Order Makanan - Menuva</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #fefefe;
      padding: 20px;
    }
    h1, h2 {
      text-align: center;
    }
    .info {
      text-align: center;
      margin-bottom: 20px;
    }
    .menu-item {
      border: 1px solid #ccc;
      margin: 10px;
      padding: 10px;
      border-radius: 10px;
    }
    .qty-controls button {
      margin: 0 5px;
    }
    .order-summary {
      margin-top: 30px;
      padding: 20px;
      border: 1px solid #ccc;
      border-radius: 10px;
    }
  </style>
</head>
<body>
  <h1>Order Menu</h1>
  <div class="info">
    <img id="logo" src="" alt="Logo" height="80" /><br>
    <strong id="namaRestoran">Nama Restoran</strong><br>
    <span id="alamatRestoran">Alamat Restoran</span><br>
    <span id="noWaRestoran">No. WhatsApp</span>
  </div>
  
  <img id="logoRestoran" alt="Logo Restoran" style="max-height:80px;" />
 <h2 id="namaRestoran"></h2>
 <p id="alamatRestoran"></p>
 <p id="teleponRestoran"></p>

  <div id="menuList"></div>

  <div class="order-summary">
    <h2>Ringkasan Pesanan</h2>
    <ul id="orderList"></ul>
    <p>Total: <span id="totalHarga">Rp 0</span></p>
    <button onclick="kirimPesananWA()">Kirim Pesanan via WA</button>
  </div>
<script>
  const DB_NAME = "MenuvaDB";
  const STORE_NAME = "menuvaData";
  const DB_VERSION = 1;

  let db;
  let data;
  const pesanan = {};

  const menuList = document.getElementById("menu-list");
  const totalItem = document.getElementById("total-item");
  const totalHarga = document.getElementById("total-harga");
  const kategoriFilter = document.getElementById("kategoriFilter");
  const logoContainer = document.getElementById("logoContainer");

  // Inisialisasi IndexedDB
  const openReq = indexedDB.open(DB_NAME, DB_VERSION);

  openReq.onerror = () => alert("‚ùå Gagal membuka database");
  openReq.onsuccess = (event) => {
    db = event.target.result;
    loadDataFromDB();
  };

  function loadDataFromDB() {
    const tx = db.transaction(STORE_NAME, "readonly");
    const store = tx.objectStore(STORE_NAME);
    const getReq = store.get(1);

    getReq.onsuccess = () => {
      data = getReq.result;
      if (!data || !data.menu || !data.menu.length) {
        menuList.innerHTML = "<p>‚ö†Ô∏è Tidak ada menu tersedia</p>";
        return;
      }

      // Tampilkan logo
      if (data.logo) {
        logoContainer.innerHTML = `<img src="${data.logo}" alt="Logo Resto" />`;
      }

      // Nama Restoran
      if (data.namaRestoran) {
        document.getElementById("namaRestoranDisplay").textContent = data.namaRestoran;
      }

      // Isi dropdown kategori
      const kategoriUnik = [...new Set(data.menu.map(m => m.kategori).filter(k => k && k.trim() !== ""))];
      kategoriUnik.forEach(k => {
        const opt = document.createElement("option");
        opt.value = k;
        opt.textContent = k;
        kategoriFilter.appendChild(opt);
      });

      tampilkanMenu();
    };

    getReq.onerror = () => {
      menuList.innerHTML = "<p>‚ùå Gagal mengambil data dari database</p>";
    };
  }

  function tampilkanMenu() {
    const kategoriDipilih = kategoriFilter.value;
    menuList.innerHTML = "";

    data.menu.forEach((item, index) => {
      if (kategoriDipilih !== "Semua" && item.kategori !== kategoriDipilih) return;

      if (pesanan[index] === undefined) pesanan[index] = 0;

      const itemEl = document.createElement("div");
      itemEl.className = "menu-item";
      itemEl.innerHTML = `
        <div>
          <div class="menu-name">${item.nama}</div>
          <div>Rp${item.harga}</div>
        </div>
        <div class="qty-controls">
          <button onclick="ubahJumlah(${index}, -1)">‚ûñ</button>
          <span id="qty-${index}">${pesanan[index]}</span>
          <button onclick="ubahJumlah(${index}, 1)">‚ûï</button>
        </div>
      `;
      menuList.appendChild(itemEl);
    });

    updateRingkasan();
  }

  function ubahJumlah(index, delta) {
    pesanan[index] = Math.max(0, (pesanan[index] || 0) + delta);
    document.getElementById(`qty-${index}`).innerText = pesanan[index];
    updateRingkasan();
  }

  function updateRingkasan() {
    let totalQty = 0;
    let totalHargaValue = 0;

    Object.entries(pesanan).forEach(([i, jumlah]) => {
      totalQty += jumlah;
      totalHargaValue += jumlah * parseInt(data.menu[i].harga || 0);
    });

    totalItem.innerText = totalQty;
    totalHarga.innerText = totalHargaValue.toLocaleString();
  }

  function kirimPesanan() {
    const nama = document.getElementById("nama").value.trim();
    const alamat = document.getElementById("alamat").value.trim();
    const waktuAntar = document.getElementById("waktuAntar").value;
    const catatan = document.getElementById("catatan").value.trim();
    const ruangan = document.getElementById("ruangan").value.trim();
    const now = new Date();
    const waktuOrder = now.toLocaleString("id-ID");

    let listPesanan = Object.entries(pesanan)
      .filter(([_, jumlah]) => jumlah > 0)
      .map(([i, jumlah]) => `${data.menu[i].nama} x${jumlah} (Rp${jumlah * parseInt(data.menu[i].harga)})`)
      .join("\n");

    if (!listPesanan) {
      alert("Belum ada item yang dipilih.");
      return;
    }

    let totalHargaAll = Object.entries(pesanan).reduce((sum, [i, jml]) => sum + (jml * parseInt(data.menu[i].harga || 0)), 0);

    let pesanWA = `üßæ Pesanan Baru dari ${nama || "Customer"}\n\n` +
      `üìÖ Tanggal Order: ${waktuOrder}\n` +
      (waktuAntar ? `üïí Waktu Antar: ${new Date(waktuAntar).toLocaleString("id-ID")}\n` : "") +
      (ruangan ? `üè® Ruangan: ${ruangan}\n` : "") +
      `\nüìç Alamat:\n${alamat}\n` +
      `\nüõí Pesanan:\n${listPesanan}\n\n` +
      `üí∞ Total: Rp${totalHargaAll.toLocaleString()}\n` +
      (catatan ? `\nüìå Catatan:\n${catatan}` : "");

    const nomorAdminList = data.nomorWaAdmin || [];

    if (nomorAdminList.length === 0) {
      alert("‚ö†Ô∏è Tidak ada nomor admin yang tersedia.");
      return;
    }

    nomorAdminList.forEach(nomor => {
      const waLink = `https://wa.me/${nomor}?text=${encodeURIComponent(pesanWA)}`;
      window.open(waLink, "_blank");
    });
  }
</script>

</body>
</html>


