<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Order Makanan - Menuva</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f9f9f9; }
    h2 { border-bottom: 2px solid #ddd; padding-bottom: 5px; }
    .menu-item, .promo-item {
      border: 1px solid #ccc; border-radius: 8px; margin: 10px 0; padding: 10px;
      display: flex; align-items: center; background: #fff;
    }
    .menu-item img, .promo-item img {
      width: 80px; height: 80px; object-fit: cover; border-radius: 6px; margin-right: 10px;
    }
    .info { flex-grow: 1; }
    .qty-control {
      display: flex; align-items: center; gap: 5px;
    }
    button { padding: 6px 10px; }
    .total { font-weight: bold; margin-top: 15px; }
  </style>
</head>
<body>
  <h1>Pesan Menu</h1>
  <div id="promo-list"></div>
  <h2>Menu Utama</h2>
  <div id="menu-list"></div>
  <div class="total">Total: <span id="totalHarga">Rp 0</span></div>
  <button onclick="kirimPesanan()">Kirim ke WhatsApp</button>

  <script>
    let db;
    const promoCart = {};
    const orderCart = {};

    function openDB() {
      const request = indexedDB.open("menuvaDB", 1);
      request.onerror = () => alert("Gagal membuka database");
      request.onsuccess = (e) => {
        db = e.target.result;
        loadData();
      };
    }

    function loadData() {
      const tx = db.transaction("menuvaData", "readonly");
      const store = tx.objectStore("menuvaData");
      const getData = store.get("menuva");

      getData.onsuccess = () => {
        const data = getData.result;
        if (!data) return alert("Data tidak ditemukan");

        tampilkanPromo(data.promo || []);
        tampilkanMenu(data.menu || []);
      };
    }

    function tampilkanPromo(promoList) {
      const container = document.getElementById("promo-list");
      if (!promoList.length) return;

      const title = document.createElement("h2");
      title.textContent = "Promo Spesial";
      container.appendChild(title);

      promoList.forEach((promo, index) => {
        const div = document.createElement("div");
        div.className = "promo-item";

        div.innerHTML = `
          <img src="${promo.gambar}" alt="${promo.namaPromo}">
          <div class="info">
            <strong>${promo.namaPromo}</strong><br>
            <small>${promo.deskripsi || ""}</small><br>
            <b>Rp ${promo.harga}</b>
          </div>
          <div class="qty-control">
            <button onclick="ubahQty('promo', ${index}, -1)">-</button>
            <span id="promoQty${index}">0</span>
            <button onclick="ubahQty('promo', ${index}, 1)">+</button>
          </div>
        `;

        container.appendChild(div);
      });
    }

    function tampilkanMenu(menuList) {
      const container = document.getElementById("menu-list");

      menuList.forEach((menu, index) => {
        const div = document.createElement("div");
        div.className = "menu-item";

        div.innerHTML = `
          <img src="${menu.gambar}" alt="${menu.nama}">
          <div class="info">
            <strong>${menu.nama}</strong><br>
            <small>${menu.kategori || ""}</small><br>
            <b>Rp ${menu.harga}</b>
          </div>
          <div class="qty-control">
            <button onclick="ubahQty('menu', ${index}, -1)">-</button>
            <span id="menuQty${index}">0</span>
            <button onclick="ubahQty('menu', ${index}, 1)">+</button>
          </div>
        `;

        container.appendChild(div);
      });
    }

    function ubahQty(tipe, index, delta) {
      const cart = tipe === "promo" ? promoCart : orderCart;
      const id = `${tipe}${index}`;
      cart[id] = (cart[id] || 0) + delta;
      if (cart[id] < 0) cart[id] = 0;
      document.getElementById(`${tipe}Qty${index}`).textContent = cart[id];

      localStorage.setItem("promoCart", JSON.stringify(promoCart));
      localStorage.setItem("orderCart", JSON.stringify(orderCart));

      hitungTotal();
    }

    function hitungTotal() {
      let total = 0;
      const promoCartData = JSON.parse(localStorage.getItem("promoCart") || "{}");
      const orderCartData = JSON.parse(localStorage.getItem("orderCart") || "{}");

      const tx = db.transaction("menuvaData", "readonly");
      const store = tx.objectStore("menuvaData");
      const getData = store.get("menuva");

      getData.onsuccess = () => {
        const data = getData.result;
        const promoList = data.promo || [];
        const menuList = data.menu || [];

        for (let key in promoCartData) {
          const index = parseInt(key.replace("promo", ""));
          const item = promoList[index];
          if (item) total += item.harga * promoCartData[key];
        }

        for (let key in orderCartData) {
          const index = parseInt(key.replace("menu", ""));
          const item = menuList[index];
          if (item) total += item.harga * orderCartData[key];
        }

        document.getElementById("totalHarga").textContent = "Rp " + total.toLocaleString("id-ID");
      };
    }

    function kirimPesanan() {
      const promoCartData = JSON.parse(localStorage.getItem("promoCart") || "{}");
      const orderCartData = JSON.parse(localStorage.getItem("orderCart") || "{}");

      const tx = db.transaction("menuvaData", "readonly");
      const store = tx.objectStore("menuvaData");
      const getData = store.get("menuva");

      getData.onsuccess = () => {
        const data = getData.result;
        const waNumber = data.noWA[0] || "";
        let pesan = `Halo, saya ingin memesan:\n`;

        (data.promo || []).forEach((item, i) => {
          const qty = promoCartData[`promo${i}`];
          if (qty) pesan += `- ${item.namaPromo} x${qty}\n`;
        });

        (data.menu || []).forEach((item, i) => {
          const qty = orderCartData[`menu${i}`];
          if (qty) pesan += `- ${item.nama} x${qty}\n`;
        });

        window.open(`https://wa.me/${waNumber}?text=${encodeURIComponent(pesan)}`, "_blank");
      };
    }

    openDB();
  </script>
</body>
</html>
