<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Order Makanan - Menuva</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #fefefe;
      padding: 20px;
    }
    h1, h2 {
      text-align: center;
    }
    .info {
      text-align: center;
      margin-bottom: 20px;
    }
    .menu-item {
      border: 1px solid #ccc;
      margin: 10px;
      padding: 10px;
      border-radius: 10px;
    }
    .qty-controls button {
      margin: 0 5px;
    }
    .order-summary {
      margin-top: 30px;
      padding: 20px;
      border: 1px solid #ccc;
      border-radius: 10px;
    }
  </style>
</head>
<body>
  <h1>Order Menu</h1>
  <div class="info">
    <img id="logo" src="" alt="Logo" height="80" /><br>
    <strong id="namaRestoran">Nama Restoran</strong><br>
    <span id="alamatRestoran">Alamat Restoran</span><br>
    <span id="noWaRestoran">No. WhatsApp</span>
  </div>

  <div id="menuList"></div>

  <div class="order-summary">
    <h2>Ringkasan Pesanan</h2>
    <ul id="orderList"></ul>
    <p>Total: <span id="totalHarga">Rp 0</span></p>
    <button onclick="kirimPesananWA()">Kirim Pesanan via WA</button>
  </div>

  <script>
    let db;

    function bukaDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open("menuvaDB", 1);

        request.onsuccess = (event) => {
          db = event.target.result;
          resolve(db);
        };

        request.onerror = (event) => {
          reject("Gagal membuka database");
        };
      });
    }

    function ambilData() {
      return new Promise((resolve, reject) => {
        const transaksi = db.transaction(["menuvaData"], "readonly");
        const store = transaksi.objectStore("menuvaData");
        const request = store.get("menuva");

        request.onsuccess = (event) => {
          const data = event.target.result;
          if (data) resolve(data);
          else reject("Data tidak ditemukan");
        };

        request.onerror = () => reject("Gagal mengambil data");
      });
    }

    function renderMenu(menuArray) {
      const menuList = document.getElementById("menuList");
      menuList.innerHTML = "";
      menuArray.forEach((menu, index) => {
        const item = document.createElement("div");
        item.className = "menu-item";
        item.innerHTML = `
          <strong>${menu.nama}</strong><br>
          <em>${menu.kategori}</em><br>
          <span>Rp ${menu.harga}</span><br>
          <div class="qty-controls">
            <button onclick="ubahQty(${index}, -1)">-</button>
            <input type="number" id="qty-${index}" value="0" min="0" readonly style="width: 30px; text-align: center;" />
            <button onclick="ubahQty(${index}, 1)">+</button>
          </div>
        `;
        menuList.appendChild(item);
      });
    }

    let pesanan = [];

    function ubahQty(index, delta) {
      const input = document.getElementById(`qty-${index}`);
      let val = parseInt(input.value) + delta;
      if (val < 0) val = 0;
      input.value = val;
      pesanan[index] = val;
      updateRingkasan();
    }

    function updateRingkasan() {
      const list = document.getElementById("orderList");
      list.innerHTML = "";
      let total = 0;
      pesanan.forEach((qty, i) => {
        if (qty > 0) {
          const nama = window.menuData[i].nama;
          const harga = window.menuData[i].harga;
          const li = document.createElement("li");
          li.textContent = `${nama} x ${qty} = Rp ${harga * qty}`;
          list.appendChild(li);
          total += harga * qty;
        }
      });
      document.getElementById("totalHarga").textContent = `Rp ${total}`;
    }

    function kirimPesananWA() {
      let pesan = "Pesanan:%0A";
      let total = 0;
      pesanan.forEach((qty, i) => {
        if (qty > 0) {
          const nama = window.menuData[i].nama;
          const harga = window.menuData[i].harga;
          pesan += `- ${nama} x ${qty} = Rp ${harga * qty}%0A`;
          total += harga * qty;
        }
      });
      pesan += `%0ATotal: Rp ${total}`;
      const nomor = document.getElementById("noWaRestoran").textContent.replace(/[^0-9]/g, "");
      window.open(`https://wa.me/${nomor}?text=${pesan}`);
    }

    bukaDB()
      .then(() => ambilData())
      .then(data => {
        document.getElementById("logo").src = data.logo;
        document.getElementById("namaRestoran").textContent = data.namaRestoran;
        document.getElementById("alamatRestoran").textContent = data.alamat;
        document.getElementById("noWaRestoran").textContent = data.nomorWaAdmin;
        window.menuData = data.menu || [];
        pesanan = new Array(window.menuData.length).fill(0);
        renderMenu(window.menuData);
      })
      .catch(err => {
        alert("Gagal memuat data: " + err);
      });
  </script>
</body>
</html>
