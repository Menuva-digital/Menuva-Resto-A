<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Order Makanan - Menuva</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f9f9f9; }
    h1, h2 { text-align: center; }
    .menu-item, .promo-item {
      border: 1px solid #ccc; border-radius: 10px; padding: 10px; margin: 10px 0;
      display: flex; align-items: center; background: #fff;
    }
    .menu-item img, .promo-item img { width: 100px; height: 100px; object-fit: cover; border-radius: 8px; margin-right: 10px; }
    .info { flex-grow: 1; }
    .qty-control { display: flex; align-items: center; gap: 10px; }
    .qty-control button { width: 30px; height: 30px; font-size: 18px; }
    .total-section { margin-top: 20px; font-size: 18px; text-align: center; }
    .order-btn { margin-top: 20px; padding: 10px; font-size: 18px; background: #25d366; color: #fff; border: none; border-radius: 5px; cursor: pointer; width: 100%; }
  </style>
</head>
<body>

  <h1>Order Menu</h1>
  <div id="promo-list"><h2>Promo</h2></div>
  <div id="menu-list"><h2>Menu</h2></div>

  <div class="total-section">
    Total: <span id="total-price">Rp 0</span>
  </div>
  <button class="order-btn" onclick="kirimPesanan()">Kirim Pesanan via WhatsApp</button>

  <script>
    let db, keranjang = {};

    function bukaDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open("menuvaDB", 1);
        request.onerror = () => reject("Gagal membuka database");
        request.onsuccess = () => {
          db = request.result;
          resolve(db);
        };
      });
    }

    function ambilDataRestoran() {
      return new Promise((resolve, reject) => {
        const tx = db.transaction("menuvaData", "readonly");
        const store = tx.objectStore("menuvaData");
        const getData = store.get("menuva");

        getData.onsuccess = () => {
          if (getData.result) resolve(getData.result);
          else reject("Data tidak ditemukan");
        };
        getData.onerror = () => reject("Gagal mengambil data");
      });
    }

    function renderItem(data, container, isPromo = false) {
      data.forEach((item, index) => {
        const div = document.createElement("div");
        div.className = isPromo ? "promo-item" : "menu-item";

        const qtyKey = `${isPromo ? "promo" : "menu"}-${index}`;
        keranjang[qtyKey] = 0;

        div.innerHTML = `
          <img src="${item.gambar || ""}" alt="gambar">
          <div class="info">
            <strong>${item.nama}</strong><br/>
            <small>${item.deskripsi || ""}</small><br/>
            <strong>Rp ${item.harga}</strong>
          </div>
          <div class="qty-control">
            <button onclick="ubahQty('${qtyKey}', -1)">âˆ’</button>
            <span id="qty-${qtyKey}">0</span>
            <button onclick="ubahQty('${qtyKey}', 1)">+</button>
          </div>
        `;

        container.appendChild(div);
      });
    }

    function ubahQty(key, delta) {
      keranjang[key] = Math.max(0, (keranjang[key] || 0) + delta);
      document.getElementById(`qty-${key}`).textContent = keranjang[key];
      hitungTotal();
    }

    function hitungTotal() {
      let total = 0;
      Object.keys(keranjang).forEach(key => {
        const [tipe, index] = key.split("-");
        const item = dataGlobal[tipe][index];
        total += keranjang[key] * Number(item.harga || 0);
      });
      document.getElementById("total-price").textContent = "Rp " + total.toLocaleString();
    }

    function kirimPesanan() {
      const lines = [];
      Object.keys(keranjang).forEach(key => {
        if (keranjang[key] > 0) {
          const [tipe, index] = key.split("-");
          const item = dataGlobal[tipe][index];
          lines.push(`- ${item.nama} x ${keranjang[key]}`);
        }
      });

      if (lines.length === 0) return alert("Keranjang masih kosong!");

      const text = `Halo Admin, saya ingin memesan:\n${lines.join("\n")}`;
      const wa = dataGlobal.noWA?.[0] || "628123456789";
      const link = `https://wa.me/${wa}?text=${encodeURIComponent(text)}`;
      window.open(link, "_blank");
    }

    let dataGlobal = {};

    bukaDB()
      .then(() => ambilDataRestoran())
      .then(data => {
        dataGlobal = data;

        const promoList = document.getElementById("promo-list");
        const menuList = document.getElementById("menu-list");

        if (data.promo && data.promo.length) {
          renderItem(data.promo, promoList, true);
        }

        if (data.menu && data.menu.length) {
          renderItem(data.menu, menuList, false);
        }

      })
      .catch(err => {
        document.body.innerHTML = "<h2 style='color:red;text-align:center;'>Gagal memuat data: " + err + "</h2>";
      });
  </script>
</body>
</html>
