<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Admin Panel - Menuva</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background-color: #f4f4f4;
      margin: 0;
    }
    .menuva-logo {
      text-align: center;
      margin-bottom: 10px;
    }
    .menuva-logo img {
      height: 90px;
    }
    h1, h2 {
      text-align: center;
      margin: 10px 0;
    }
    .section {
      background: #fff;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 10px;
      box-shadow: 0 3px 6px rgba(0,0,0,0.1);
    }
    input, button {
      padding: 10px;
      margin: 5px 0;
      border-radius: 5px;
      border: 1px solid #ccc;
      width: 100%;
      font-size: 1rem;
    }
    .menu-item {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 10px;
    }
    .menu-item input {
      flex: 1 1 40%;
    }
    .menu-item button {
      flex: 1 1 auto;
      white-space: nowrap;
    }
    .btn-danger {
      background-color: #e74c3c;
      color: white;
    }
    .btn-success {
      background-color: #2ecc71;
      color: white;
    }
    .btn-secondary {
      background-color: #3498db;
      color: white;
    }
    .preview img {
      max-width: 100px;
      margin: 5px;
      border-radius: 5px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }
    @media (max-width: 600px) {
      .menu-item input, .menu-item button {
        width: 100%;
      }
    }
    .btn-orange {
  background-color: orange;
  color: white;
  border: none;
}

  </style>
</head>
<body>

  <div class="menuva-logo">
    <img src="menuva-logo.png" alt="Logo Menuva">
  </div>

  <div class="section">
    <h2>ğŸ“‡ Identitas Restoran</h2>
    <input type="file" id="logoInput" accept="image/*" />
    <img id="previewLogo" src="" alt="Logo Restoran" style="max-height: 80px; margin-top: 10px;" />
    <input type="text" id="namaRestoran" placeholder="Nama Restoran" />
  </div>

  <div class="section">
    <h2>ğŸ“‹ FOOD MENU</h2>
    <div id="menuFoodContainer"></div>
    <button class="btn-success" onclick="tambahMenu('food')">+ Tambah Menu</button>
  </div>
  
  <div class="section">
    <h2>ğŸ“‹ SNACK & DESSERT</h2>
    <div id="menuSnackContainer"></div>
    <button class="btn-success" onclick="tambahMenu('snack')">+ Tambah Menu</button>
  </div>
  
  <div class="section">
    <h2>ğŸ“‹ DRINK</h2>
    <div id="menuDrinkContainer"></div>
    <button class="btn-success" onclick="tambahMenu('drink')">+ Tambah Menu</button>
  </div>
  
  <h3>ğŸ“± Nomor WhatsApp Admin (Penerima Pesanan/Reservasi)</h3>
  <div id="nomorWaContainer">
  <input type="text" class="nomor-wa" placeholder="Contoh: 6281234567890">
  </div>
  <button onclick="tambahNomorWa()">Tambah Nomor WA</button>

 <div class="section">
  <h2>ğŸ“¸ Galeri Ruangan</h2>
  <button onclick="tambahGambar('ruangan')">+ Tambah Gambar Ruangan</button>
  <input type="file" id="flipbookRuanganUpload" accept="image/*" multiple style="display:none;" />
  <div id="flipbookRuanganPreview"></div>
</div>

<div class="section">
  <h2>ğŸ“– Menu Restoran</h2>
  <button onclick="tambahGambar('menu')">+ Tambah Gambar Menu</button>
  <input type="file" id="flipbookMenuUpload" accept="image/*" multiple style="display:none;" />
  <div id="flipbookMenuPreview"></div>
</div>

  <div class="section">
    <button onclick="simpanData()">ğŸ’¾ Simpan Semua</button>
    <button onclick="window.open('menu.html')" style="margin-top: 10px;">ğŸ‘ï¸ Lihat Halaman Customer</button>
    <button id="btnSalinLink" onclick="salinLinkMenu()" style="display:none; background-color: rgb(58, 82, 219); color: white; padding: 10px; border: none; border-radius: 8px; margin-top: 10px;">
      ğŸ“‹ Copy Link Page Customer.html
    </button>
    
    <!-- Backup dan Restore -->
<div class="section">
  <h2>ğŸ” Backup & Restore Data</h2>
  <button onclick="backupData()">â¬‡ï¸ Backup Data</button>
  <input type="file" id="restoreInput" accept=".json" />
  
  <div style="background: #fef9e7; padding: 10px; border-left: 5px solid #f1c40f; margin-top: 10px; font-size: 14px;">
    <strong>Panduan Penggunaan:</strong><br>
    PENTING!!<br>
    ğŸ”¹ Klik <strong>â¬‡ï¸ Backup Data</strong> untuk menyimpan semua data restoran ke file berformat <strong>.json</strong>.<br>
    ğŸ”¹ Simpan file tersebut dengan baik dan aman di perangkat Anda.<br>
    ğŸ”¹ Klik <strong>ğŸ“‚ Pilih File</strong untuk me-restore data dari file <strong>.json</strong> hasil backup.<br>
    âš ï¸ Proses restore akan menggantikan seluruh data yang ada saat ini dan tidak bisa dibatalkan.<br>
    ğŸ’¡ Gunakan fitur ini sebelum mengganti perangkat atau membersihkan data browser.
  </div>
</div>

    <button onclick="window.location.href='index.html'" class="btn-secondary" style="margin-top: 10px;">ğŸ”’ Logout</button>
    <button onclick="resetData()" class="btn-danger" style="margin-top: 10px;">ğŸ—‘ï¸ Reset Semua Data</button>
  </div>

  <script>
    
    // Variabel global
    let flipbookRuanganImages = JSON.parse(localStorage.getItem('menuvaData'))?.flipbookRuanganImages || [];
    let flipbookMenuImages = JSON.parse(localStorage.getItem('menuvaData'))?.flipbookMenuImages || [];
  
    // Fungsi simpan ke localStorage
    function updateLocalStorage(updates) {
      const saved = JSON.parse(localStorage.getItem('menuvaData')) || {};
      const merged = { ...saved, ...updates };
      localStorage.setItem('menuvaData', JSON.stringify(merged));
    }

    function resizeIfNeeded(file, maxSizeMB = 1, maxWidth = 1024, quality = 0.7) {
    return new Promise((resolve, reject) => {
      if (file.size <= maxSizeMB * 1024 * 1024) {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      } else {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement("canvas");
            const scale = Math.min(maxWidth / img.width, 1);
            canvas.width = img.width * scale;
            canvas.height = img.height * scale;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            const resized = canvas.toDataURL("image/jpeg", quality);
            resolve(resized);
          };
          img.onerror = reject;
          img.src = e.target.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      }
    });
  }

  // Upload logo
  document.getElementById('logoInput').addEventListener('change', async function (e) {
    const file = e.target.files[0];
    if (!file) return;
    try {
      const logoUrl = await resizeIfNeeded(file);
      document.getElementById('previewLogo').src = logoUrl;
      updateLocalStorage({ logo: logoUrl });
    } catch (err) {
      alert("âŒ Gagal memproses gambar logo.");
      console.error("Logo error:", err);
    }
  });

  // Upload flipbook ruangan
  document.getElementById('flipbookRuanganUpload').addEventListener('change', async function (e) {
    const files = Array.from(e.target.files);
    const previewDiv = document.getElementById('flipbookRuanganPreview');
    previewDiv.innerHTML = '';
    flipbookRuanganImages = [];

    for (const file of files) {
      try {
        const imageUrl = await resizeIfNeeded(file);
        flipbookRuanganImages.push(imageUrl);
        renderImagePreview('ruangan', imageUrl);
      } catch (err) {
        alert("âŒ Gagal memproses gambar ruangan.");
        console.error("Ruangan error:", err);
      }
    }
    updateLocalStorage({ flipbookRuanganImages });
  });

  // Upload flipbook menu
  document.getElementById('flipbookMenuUpload').addEventListener('change', async function (e) {
    const files = Array.from(e.target.files);
    const previewDiv = document.getElementById('flipbookMenuPreview');
    previewDiv.innerHTML = '';
    flipbookMenuImages = [];

    for (const file of files) {
      try {
        const imageUrl = await resizeIfNeeded(file);
        flipbookMenuImages.push(imageUrl);
        renderImagePreview('menu', imageUrl);
      } catch (err) {
        alert("âŒ Gagal memproses gambar menu.");
        console.error("Menu error:", err);
      }
    }
    updateLocalStorage({ flipbookMenuImages });
  });
  
    // Tambah menu
    function tambahMenu(kategori = 'food', nama = '', harga = '') {
      const containerId = {
        food: 'menuFoodContainer',
        snack: 'menuSnackContainer',
        drink: 'menuDrinkContainer'
      }[kategori];
  
      const container = document.getElementById(containerId);
      const div = document.createElement('div');
      div.className = 'menu-item';
      div.innerHTML = `
        <input type="text" placeholder="Nama Menu" value="${nama}" />
        <input type="number" placeholder="Harga" value="${harga}" />
        <select>
          <option value="food" ${kategori === 'food' ? 'selected' : ''}>Food</option>
          <option value="snack" ${kategori === 'snack' ? 'selected' : ''}>Snack</option>
          <option value="drink" ${kategori === 'drink' ? 'selected' : ''}>Drink</option>
        </select>
        <button class="btn-danger" onclick="this.parentElement.remove()">Hapus</button>
      `;
      container.appendChild(div);
    }
  
    // Tambah input nomor WA
    function tambahNomorWa() {
      const container = document.getElementById('nomorWaContainer');
      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'nomor-wa';
      input.placeholder = 'Contoh: 6281234567890';
      container.appendChild(input);
    }
  
    // Simpan semua data
    function simpanData() {
  const namaRestoran = document.getElementById('namaRestoran').value;
  const logo = document.getElementById('previewLogo').src;

  function ambilMenu(containerId) {
    const items = document.querySelectorAll(`#${containerId} .menu-item`);
    const list = [];
    items.forEach(item => {
      const nama = item.children[0].value;
      const harga = item.children[1].value;
      const kategori = item.children[2].value;
      if (nama && harga) list.push({ nama, harga, kategori });
    });
    return list;
  }

  const nomorWaInputs = document.querySelectorAll('.nomor-wa');
  const nomorWaAdmin = Array.from(nomorWaInputs).map(input => input.value.trim()).filter(val => val !== '');

  const data = {
    namaRestoran,
    logo,
    nomorWaAdmin,
    flipbookRuanganImages,
    flipbookMenuImages,
    menu: [
      ...ambilMenu('menuFoodContainer'),
      ...ambilMenu('menuSnackContainer'),
      ...ambilMenu('menuDrinkContainer')
    ]
  };

  try {
    localStorage.setItem('menuvaData', JSON.stringify(data));
    alert('âœ… Data berhasil disimpan!');
    document.getElementById('btnSalinLink').style.display = 'inline-block';
  } catch (err) {
    console.error("âŒ Gagal menyimpan data ke localStorage:", err);
    alert("âŒ Gagal menyimpan data! Mungkin ukuran total gambar terlalu besar.\n\nTips:\n- Kurangi jumlah gambar\n- Gunakan gambar berukuran di bawah 300KB/Gambar\n- Cek koneksi Anda");
  }
}

  
    // Reset data
    function resetData() {
      if (confirm("Yakin ingin menghapus semua data?")) {
        localStorage.removeItem('menuvaData');
        location.reload();
      }
    }
  
    // Backup data
    function backupData() {
  try {
    const data = localStorage.getItem("menuvaData");
    if (!data) {
      alert("âš ï¸ Tidak ada data yang bisa di-backup.");
      return;
    }

    const blob = new Blob([data], { type: "application/json" });
    const url = URL.createObjectURL(blob);

    console.log("ğŸ“¦ Blob URL:", url);
    console.log("ğŸ“ Blob size:", blob.size, "bytes");
    console.log("ğŸ–±ï¸ Simulasi klik tombol download...");

    const a = document.createElement("a");
    a.href = url;
    a.download = "menuva-backup.json";

    // Ini penting agar di HP tetap terdeteksi interaksi user
    a.style.display = 'none';
    document.body.appendChild(a);
    a.click();

    setTimeout(() => {
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      console.log("âœ… Link download selesai dan URL dibersihkan.");
    }, 100);

    alert("âœ… Backup dimulai. Jika tidak muncul download, cek izin browser.");
  } catch (err) {
    console.error("âŒ Gagal backup:", err);
    alert("Terjadi kesalahan saat backup data.");
  }
}
    // Salin link
    function salinLinkMenu() {
      const origin = window.location.origin;
      const linkMenu = `${origin}/menu.html`;
  
      navigator.clipboard.writeText(linkMenu)
        .then(() => {
          alert(`âœ… Link menu berhasil disalin:\n${linkMenu}`);
          window.open(linkMenu, '_blank');
        })
        .catch(() => alert('âŒ Gagal menyalin link'));
    }
  
    // Render preview gambar
    function renderImagePreview(tipe, url) {
      const img = document.createElement('img');
      img.src = url;
      img.style.maxWidth = '100px';
      img.style.margin = '5px';
      img.style.border = '1px solid #ccc';
  
      const wrapper = document.createElement('div');
      wrapper.style.display = 'inline-block';
      wrapper.style.position = 'relative';
      wrapper.style.margin = '5px';
  
      const btnHapus = document.createElement('button');
      btnHapus.innerText = 'âŒ';
      btnHapus.style.position = 'absolute';
      btnHapus.style.top = '0';
      btnHapus.style.right = '0';
      btnHapus.style.background = 'red';
      btnHapus.style.color = 'white';
      btnHapus.style.border = 'none';
      btnHapus.style.cursor = 'pointer';
  
      btnHapus.onclick = function () {
        wrapper.remove();
        if (tipe === 'ruangan') {
          flipbookRuanganImages = flipbookRuanganImages.filter(src => src !== url);
        } else {
          flipbookMenuImages = flipbookMenuImages.filter(src => src !== url);
        }
        updateLocalStorage({ flipbookRuanganImages, flipbookMenuImages });
      };
  
      wrapper.appendChild(img);
      wrapper.appendChild(btnHapus);
  
      const previewContainer = tipe === 'ruangan' ? 'flipbookRuanganPreview' : 'flipbookMenuPreview';
      document.getElementById(previewContainer).appendChild(wrapper);
    }
  
    // Tambah gambar manual
    function tambahGambar(tipe) {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/*';
  input.style.display = 'none';

  input.onchange = async function (e) {
    const file = e.target.files[0];
    if (!file) return;

    try {
      const imageUrl = await resizeIfNeeded(file); // â¬…ï¸ Ini harus aktif
      renderImagePreview(tipe, imageUrl);

      if (tipe === 'ruangan') {
        flipbookRuanganImages.push(imageUrl);
      } else {
        flipbookMenuImages.push(imageUrl);
      }

      updateLocalStorage({ flipbookRuanganImages, flipbookMenuImages });
    } catch (err) {
      alert("âŒ Gagal memproses gambar.");
      console.error("Error resize:", err);
    }
  };

  document.body.appendChild(input);
  input.click();
  document.body.removeChild(input);
}

  
    // Load data saat halaman dibuka
    window.onload = function () {
      const saved = localStorage.getItem('menuvaData');
      if (saved) {
        const data = JSON.parse(saved);
        document.getElementById('namaRestoran').value = data.namaRestoran || '';
        if (data.logo) document.getElementById('previewLogo').src = data.logo;
  
        (data.menu || []).forEach(m => tambahMenu(m.kategori || 'food', m.nama, m.harga));
        (data.nomorWaAdmin || []).forEach(no => {
          tambahNomorWa();
          const nomorInputs = document.querySelectorAll('.nomor-wa');
          nomorInputs[nomorInputs.length - 1].value = no;
        });
  
        (data.flipbookRuanganImages || []).forEach(src => renderImagePreview('ruangan', src));
        (data.flipbookMenuImages || []).forEach(src => renderImagePreview('menu', src));
      }
    };
  
    // Log error global
    window.addEventListener("error", function (e) {
      console.error("âŒ Terjadi error:", e.message);
    });
  </script>
  

</body>
</html>
